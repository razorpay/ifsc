# Changelog Writer Sub-Skill (Enhanced)

## Purpose
Generate comprehensive release notes by analyzing data changes, cloning ifsc-api repo, and creating human-readable changelog entries.

## When to Use
- After dataset generation and validation
- Before creating release commit
- When preparing GitHub release

## Changelog Components

### 1. CHANGELOG.md (Project History)
**Format**: [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)

**Structure**:
```markdown
# Changelog

## [UNRELEASED][unreleased]
## [2.0.54][2.0.54]
### Changed
- Metadata updates
- Added 234 new IFSCs
- Removed 12 closed branches
- Updated SWIFT codes for 45 SBI branches

## [2.0.53][2.0.53]
### Changed
- Metadata updates
```

**Categories**:
- **Added**: New IFSCs, new banks, new features
- **Changed**: Metadata updates, SWIFT updates, bank name changes
- **Removed**: Closed branches, merged banks
- **Fixed**: Incorrect MICR codes, wrong state names

### 2. release.md (Detailed Release Notes)
**Generated by**: `scraper/scripts/release.sh`

**Purpose**: Per-IFSC detailed changelog for API consumers

**Example**:
```markdown
# Release 2.0.54

## Summary
- Total IFSCs: 177,569
- Added: 234 new branches
- Removed: 12 closed branches
- Modified: 1,023 metadata updates

## Added IFSCs
- SBIN0012345 - State Bank of India, Mumbai New Branch
- HDFC0006789 - HDFC Bank, Delhi Connaught Place
- ...

## Removed IFSCs
- SBIN0099999 - Branch closed
- HDFC0099998 - Merged with HDFC0000001
- ...

## Modified IFSCs
- SBIN0000001: Address updated
- HDFC0000002: Phone number changed
- ICIC0000003: SWIFT code added
- ...
```

## Generation Workflow

### Step 1: Clone ifsc-api Repository
**Purpose**: Compare current data with previous release to find changes

**Implementation**:
```bash
git clone https://github.com/razorpay/ifsc-api.git --depth 1
```

**Why ifsc-api?**
- Contains the **distributed data** from previous releases
- Has individual JSON files per bank for easy comparison
- Git diff shows exact IFSC changes

### Step 2: Extract Current Data
```bash
cd data
tar -xzvf by-bank.tar.gz
```

**Result**: Extracts all `data/by-bank/*.json` files

### Step 3: Copy to ifsc-api for Comparison
```bash
cp data/by-bank/* ifsc-api/data/
cd ifsc-api
git add data/
```

**Git Status**:
- New files = Added IFSCs
- Modified files = Changed metadata
- Deleted files = Removed IFSCs (rare)

### Step 4: Generate Diff of Changed IFSCs
```bash
git diff --ignore-all-space --staged -U0 | \
  grep '"IFSC": "' | \
  awk '{print $1substr($3,2,11)}' | \
  sort -u > diff.txt
```

**Explanation**:
- `git diff --staged`: Show changes in staged files
- `-U0`: No context lines (only changed lines)
- `grep '"IFSC": "'`: Extract lines with IFSC codes
- `awk`: Parse IFSC from JSON line
- `sort -u`: Unique, sorted list of changed IFSCs

**Output** (`diff.txt`):
```
SBIN0000001
HDFC0000002
ICIC0000003
YESB0000004
```

### Step 5: Analyze Changes with PHP Script
```bash
php releasenotes.php > release.md
```

**releasenotes.php** (simplified logic):
```php
<?php
$changed_ifsc = file('diff.txt', FILE_IGNORE_NEW_LINES);
$old_data = load_json('ifsc-api/data/');
$new_data = load_json('../data/by-bank/');

$added = [];
$removed = [];
$modified = [];

foreach ($changed_ifsc as $ifsc) {
    $old = $old_data[$ifsc] ?? null;
    $new = $new_data[$ifsc] ?? null;

    if ($old === null && $new !== null) {
        $added[] = $ifsc;
    } elseif ($old !== null && $new === null) {
        $removed[] = $ifsc;
    } else {
        $modified[] = detect_changes($old, $new);
    }
}

// Generate markdown report
echo "## Added (" . count($added) . ")\n";
foreach ($added as $ifsc) {
    echo "- $ifsc: {$new_data[$ifsc]['BRANCH']}\n";
}

echo "\n## Removed (" . count($removed) . ")\n";
foreach ($removed as $ifsc) {
    echo "- $ifsc: {$old_data[$ifsc]['BRANCH']}\n";
}

echo "\n## Modified (" . count($modified) . ")\n";
foreach ($modified as $change) {
    echo "- {$change['ifsc']}: {$change['field']} changed\n";
}
?>
```

### Step 6: Update CHANGELOG.md
**Automated Entry**:
```markdown
## [UNRELEASED][unreleased]
## [2.0.54][2.0.54]
### Changed
- Metadata updates
- Added {count($added)} new IFSCs
- Removed {count($removed)} closed branches
{if significant_changes}
- Updated SWIFT codes for {count($swift_changes)} branches
- Fixed state names for {count($state_fixes)} entries
{/if}
```

**Rules for Detailed Entries**:
- If >50 added: Mention in changelog
- If >10 removed: Mention in changelog
- If SWIFT changes >20: Mention in changelog
- If bank name changes: Always mention
- If major feature: Add "Added" section

## Change Detection Logic

### Field-Level Comparison
```ruby
def detect_changes(old_entry, new_entry)
  changes = []

  FIELDS = ['BRANCH', 'ADDRESS', 'CONTACT', 'MICR', 'SWIFT', 'STATE', 'CITY', 'UPI', 'IMPS', 'RTGS', 'NEFT']

  FIELDS.each do |field|
    if old_entry[field] != new_entry[field]
      changes << {
        ifsc: new_entry['IFSC'],
        field: field,
        old: old_entry[field],
        new: new_entry[field]
      }
    end
  end

  changes
end
```

### Categorizing Changes

**Major Changes** (always mention):
- Bank name changes
- New banks added
- Bank mergers
- Payment system support (UPI/IMPS/RTGS/NEFT toggled)

**Minor Changes** (summarize):
- Phone number updates
- Address corrections
- MICR code fixes
- State normalization

**Batch Changes** (group):
- If same change type affects >50 IFSCs, group them:
  ```
  - Updated contact numbers for 234 branches
  - Fixed state names for 145 entries
  - Added SWIFT codes for 67 SBI branches
  ```

## Version Bump Decision

**Based on change magnitude** (from release-decision-maker):

```ruby
added_count = added_ifsc.count
removed_count = removed_ifsc.count
modified_count = modified_ifsc.count

total_changes = added_count + removed_count + modified_count

if total_changes < 50
  # Skip release
  changelog_entry = nil
elsif total_changes < 500
  # Patch version: 2.0.53 â†’ 2.0.54
  version_bump = 'patch'
elsif total_changes < 5000
  # Minor version: 2.0.54 â†’ 2.1.0
  version_bump = 'minor'
else
  # Major version: 2.1.0 â†’ 3.0.0 (rare)
  version_bump = 'major'
end
```

## Changelog Templates

### Template: Patch Release (50-500 changes)
```markdown
## [2.0.54][2.0.54]
### Changed
- Metadata updates
```

### Template: Minor Release (500-5000 changes)
```markdown
## [2.1.0][2.1.0]
### Added
- 234 new IFSCs across 12 banks

### Changed
- Metadata updates for 1,023 branches
- Updated SWIFT codes for 45 SBI branches

### Removed
- 12 closed branches
```

### Template: Major Release (>5000 changes or breaking changes)
```markdown
## [3.0.0][3.0.0]
### Added
- Support for UPI 2.0 enabled branches
- 2,345 new IFSC codes

### Changed
- **BREAKING**: Renamed STATE field values to ISO format
- **BREAKING**: MICR field now always 9 digits (was variable)
- Metadata updates for 8,934 branches

### Removed
- 234 closed branches due to bank mergers
```

## Integration with Git

### Commit Message from Changelog
```bash
VERSION=$(node -p "require('./package.json').version")

git add CHANGELOG.md package.json data/

git commit -m "$(cat <<EOF
[release] ${VERSION}

$(head -n 10 release.md)

ðŸ¤– Generated with Claude Code
EOF
)"
```

**Result**:
```
[release] 2.0.54

Added 234 new IFSCs
Removed 12 closed branches
Updated metadata for 1,023 branches

ðŸ¤– Generated with Claude Code
```

## Error Handling

### ifsc-api Clone Failure
```
â†’ Retry 3 times with exponential backoff
â†’ If all fail, use previous release data from local cache
â†’ Log warning: "Could not fetch latest ifsc-api, using cached data"
```

### Diff Extraction Failure
```
â†’ Fall back to full dataset comparison (slow but complete)
â†’ Compare JSON files manually using jq/Ruby
```

### No Changes Detected
```
if diff.txt is empty:
  â†’ Skip changelog entry
  â†’ Skip release
  â†’ Log: "No IFSC changes detected, skipping release"
```

## Success Criteria

- âœ… CHANGELOG.md updated with new version
- âœ… release.md generated with detailed changes
- âœ… Change counts are accurate
- âœ… Version bump matches change magnitude
- âœ… Commit message includes summary

## Output Files

1. **CHANGELOG.md** - Updated with new entry
2. **release.md** - Detailed per-IFSC changes
3. **diff.txt** - List of changed IFSCs (temporary)

## Performance

**Typical Times**:
- Clone ifsc-api: 10 seconds
- Extract tarball: 5 seconds
- Generate diff: 15 seconds
- Analyze changes: 20 seconds
- Update CHANGELOG: 1 second

**Total**: ~50 seconds

## Example Output

### release.md (Sample)
```markdown
# Release 2.0.54

## Summary
- Total IFSCs: 177,569 (+234 from previous release)
- Added: 234 new branches
- Removed: 12 closed branches
- Modified: 1,023 metadata updates

## Top Changes
- Contact updates: 456 branches
- Address corrections: 234 branches
- SWIFT codes added: 67 branches (SBI)
- State fixes: 145 branches
- UPI enabled: 121 branches

## Added IFSCs (234)
- SBIN0012345 - State Bank of India, Mumbai Andheri East Branch
- SBIN0012346 - State Bank of India, Delhi Rohini Sector 18
- HDFC0006789 - HDFC Bank, Bangalore Whitefield
... (truncated)

## Removed IFSCs (12)
- SBIN0099999 - Mumbai Fort Branch (Merged with SBIN0000001)
- PUNB0078901 - Delhi Karol Bagh (Branch closed)
... (truncated)

## Modified IFSCs (1,023)
- SBIN0000001: Contact updated (022-12345678 â†’ 022-87654321)
- HDFC0000001: Address corrected
- ICIC0000001: SWIFT code added (ICICINBB001)
... (truncated)
```

## Related Files

- `scraper/scripts/release.sh` - Bash script for release workflow
- `scraper/scripts/releasenotes.php` - PHP script for detailed analysis
- `CHANGELOG.md` - Project changelog
- `.github/workflows/scraper.yml:56-76` - Release notes generation job

## Future Enhancements

### AI-Powered Summaries
```python
# Use LLM to generate human-friendly summaries
changes_json = load_changes('diff.txt')
summary = anthropic.messages.create(
    model="claude-sonnet-4-5",
    messages=[{
        "role": "user",
        "content": f"Summarize these IFSC changes: {changes_json}"
    }]
)
```

### Automated Bank-Level Insights
```
Detect patterns:
- "234 new State Bank of India branches added (mostly in Maharashtra)"
- "12 Punjab National Bank branches closed (bank merger in progress)"
- "SWIFT codes added for all HDFC international branches"
```

### Slack/Email Notifications
```
â†’ Send release summary to team channel
â†’ Notify data consumers of breaking changes
â†’ Alert if major banks affected
```
